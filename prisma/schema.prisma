generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String          @id @default(cuid())
  clerkId             String?          @unique
  name                String?
  email               String          @unique
  image               String?
  role                Role            @default(STUDENT)
  githubUsername      String?
  githubAccessToken   String?
  googleDriveAccessToken   String?
  googleDriveRefreshToken  String?
  dropboxAccessToken       String?
  dropboxRefreshToken      String?
  overleafAccessToken String?
  // Notification preferences
  phoneNumber         String?         // WhatsApp number (format: +521234567890)
  emailNotifications  Boolean         @default(true)
  whatsappNotifications Boolean       @default(false)
  notifyOnMembershipRequest Boolean   @default(true)
  notifyOnComment     Boolean         @default(true)
  notifyOnTaskAssigned Boolean        @default(true)
  notifyOnProjectUpdate Boolean       @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  activityLogs        ActivityLog[]
  comments            Comment[]
  ownedProjects       Project[]       @relation("OwnerProjects")
  memberships         ProjectMember[]
  tasksAssigned       Task[]          @relation("TaskAssignee")
  aiConversations     AIConversation[]
}

model Project {
  id                  String          @id @default(cuid())
  title               String
  shortSummary        String
  description         String
  topic               String
  category            String
  status              ProjectStatus   @default(DRAFT)
  visibility          Visibility      @default(PRIVATE)
  programmingLangs    String[]
  libraries           String[]
  requiredSkills      String[]
  institution         String          @default("Universidad Panamericana")
  ownerId             String
  githubRepoUrl       String?
  githubRepoName      String?
  githubRepoOwner     String?
  githubRepoData      Json?
  githubWebhookId     String?
  githubWebhookSecret String?
  googleDriveFolderId String?
  googleDriveFolderUrl String?
  dropboxFolderId     String?
  dropboxFolderUrl    String?
  overleafProjectId   String?
  overleafProjectUrl  String?
  overleafProjectData Json?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  activityLogs        ActivityLog[]
  comments            Comment[]
  owner               User            @relation("OwnerProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members             ProjectMember[]
  tasks               Task[]
  aiConversations     AIConversation[]
  calendarEvents      CalendarEvent[]
  meetings            Meeting[]
}

model ProjectMember {
  id        String           @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole      @default(ASSISTANT)
  status    MembershipStatus @default(ACTIVE)
  createdAt DateTime         @default(now())
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Task {
  id          String       @id @default(cuid())
  projectId   String
  title       String
  description String?
  type        TaskType     @default(TODO)
  status      TaskStatus   @default(BACKLOG)
  priority    TaskPriority @default(MEDIUM)
  assigneeId  String?
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assigneeId])
}

model Comment {
  id        String   @id @default(cuid())
  projectId String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([authorId])
}

model ActivityLog {
  id        String       @id @default(cuid())
  projectId String
  actorId   String?
  type      ActivityType
  message   String
  createdAt DateTime     @default(now())
  actor     User?        @relation(fields: [actorId], references: [id])
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
}

model AIConversation {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  messages  Json     // Array of {role: "user" | "assistant", content: string}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
}

model CalendarEvent {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime?
  location    String?
  googleCalendarEventId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([startTime])
}

model Meeting {
  id              String   @id @default(cuid())
  projectId       String
  title           String
  description     String?
  scheduledTime   DateTime
  duration        Int?     // Duration in minutes
  zoomMeetingId   String?
  zoomJoinUrl     String?
  googleMeetUrl   String?
  calendarEventId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([scheduledTime])
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  n8nWorkflowId String? // ID of the workflow in n8n
  isActive    Boolean  @default(true)
  config      Json?    // Workflow configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  executions  WorkflowExecution[]

  @@index([isActive])
}

model WorkflowExecution {
  id          String   @id @default(cuid())
  workflowId String?
  n8nExecutionId String? // ID of the execution in n8n
  status      String   // "success" | "error" | "running"
  inputData   Json?
  outputData  Json?
  error       String?
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  workflow    Workflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)

  @@index([workflowId])
  @@index([startedAt])
}

enum Role {
  STUDENT
  PROFESSOR
  ADMIN
}

enum ProjectStatus {
  DRAFT
  PLANNING
  DATA_COLLECTION
  ANALYSIS
  WRITING
  REVIEW
  COMPLETED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum ProjectRole {
  PI
  CO_AUTHOR
  ASSISTANT
  REVIEWER
  FOLLOWER
}

enum MembershipStatus {
  ACTIVE
  PENDING
  REJECTED
  LEFT
}

enum TaskType {
  TODO
  MILESTONE
  DATA_CLEANING
  ANALYSIS
  WRITING
  REVIEW
}

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  PROJECT_CREATED
  PROJECT_UPDATED
  STATUS_CHANGED
  MEMBER_JOIN_REQUEST
  MEMBER_APPROVED
  MEMBER_REJECTED
  COMMENT_ADDED
  TASK_CREATED
  TASK_UPDATED
  GITHUB_REPO_CONNECTED
  GITHUB_REPO_DISCONNECTED
  GITHUB_COMMIT
  GITHUB_ISSUE_CREATED
  GITHUB_ISSUE_CLOSED
  GITHUB_PULL_REQUEST
  OVERLEAF_PROJECT_CONNECTED
  OVERLEAF_PROJECT_DISCONNECTED
}
